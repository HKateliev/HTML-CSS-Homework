{"ast":null,"code":"'use strict';\n\nconst BB = require('bluebird');\nconst fs = require('fs');\nconst getStream = require('get-stream');\nconst mkdirp = BB.promisify(require('mkdirp'));\nconst npa = require('npm-package-arg');\nconst optCheck = require('./lib/util/opt-check.js');\nconst PassThrough = require('stream').PassThrough;\nconst path = require('path');\nconst rimraf = BB.promisify(require('rimraf'));\nconst withTarballStream = require('./lib/with-tarball-stream.js');\nmodule.exports = tarball;\nfunction tarball(spec, opts) {\n  opts = optCheck(opts);\n  spec = npa(spec, opts.where);\n  return withTarballStream(spec, opts, stream => getStream.buffer(stream));\n}\nmodule.exports.stream = tarballStream;\nfunction tarballStream(spec, opts) {\n  opts = optCheck(opts);\n  spec = npa(spec, opts.where);\n  const output = new PassThrough();\n  let hasTouchedOutput = false;\n  let lastError = null;\n  withTarballStream(spec, opts, stream => {\n    if (hasTouchedOutput && lastError) {\n      throw lastError;\n    } else if (hasTouchedOutput) {\n      throw new Error('abort, abort!');\n    } else {\n      return new BB((resolve, reject) => {\n        stream.on('error', reject);\n        output.on('error', reject);\n        output.on('error', () => {\n          hasTouchedOutput = true;\n        });\n        output.on('finish', resolve);\n        stream.pipe(output);\n        stream.once('data', () => {\n          hasTouchedOutput = true;\n        });\n      }).catch(err => {\n        lastError = err;\n        throw err;\n      });\n    }\n  }).catch(err => output.emit('error', err));\n  return output;\n}\nmodule.exports.toFile = tarballToFile;\nfunction tarballToFile(spec, dest, opts) {\n  opts = optCheck(opts);\n  spec = npa(spec, opts.where);\n  return mkdirp(path.dirname(dest)).then(() => withTarballStream(spec, opts, stream => {\n    return rimraf(dest).then(() => new BB((resolve, reject) => {\n      const writer = fs.createWriteStream(dest);\n      stream.on('error', reject);\n      writer.on('error', reject);\n      writer.on('close', resolve);\n      stream.pipe(writer);\n    }));\n  }));\n}","map":{"version":3,"names":["BB","require","fs","getStream","mkdirp","promisify","npa","optCheck","PassThrough","path","rimraf","withTarballStream","module","exports","tarball","spec","opts","where","stream","buffer","tarballStream","output","hasTouchedOutput","lastError","Error","resolve","reject","on","pipe","once","catch","err","emit","toFile","tarballToFile","dest","dirname","then","writer","createWriteStream"],"sources":["/Users/hkateliev/node_modules/npm/node_modules/pacote/tarball.js"],"sourcesContent":["'use strict'\n\nconst BB = require('bluebird')\n\nconst fs = require('fs')\nconst getStream = require('get-stream')\nconst mkdirp = BB.promisify(require('mkdirp'))\nconst npa = require('npm-package-arg')\nconst optCheck = require('./lib/util/opt-check.js')\nconst PassThrough = require('stream').PassThrough\nconst path = require('path')\nconst rimraf = BB.promisify(require('rimraf'))\nconst withTarballStream = require('./lib/with-tarball-stream.js')\n\nmodule.exports = tarball\nfunction tarball (spec, opts) {\n  opts = optCheck(opts)\n  spec = npa(spec, opts.where)\n  return withTarballStream(spec, opts, stream => getStream.buffer(stream))\n}\n\nmodule.exports.stream = tarballStream\nfunction tarballStream (spec, opts) {\n  opts = optCheck(opts)\n  spec = npa(spec, opts.where)\n  const output = new PassThrough()\n  let hasTouchedOutput = false\n  let lastError = null\n  withTarballStream(spec, opts, stream => {\n    if (hasTouchedOutput && lastError) {\n      throw lastError\n    } else if (hasTouchedOutput) {\n      throw new Error('abort, abort!')\n    } else {\n      return new BB((resolve, reject) => {\n        stream.on('error', reject)\n        output.on('error', reject)\n        output.on('error', () => { hasTouchedOutput = true })\n        output.on('finish', resolve)\n        stream.pipe(output)\n        stream.once('data', () => { hasTouchedOutput = true })\n      }).catch(err => {\n        lastError = err\n        throw err\n      })\n    }\n  })\n    .catch(err => output.emit('error', err))\n  return output\n}\n\nmodule.exports.toFile = tarballToFile\nfunction tarballToFile (spec, dest, opts) {\n  opts = optCheck(opts)\n  spec = npa(spec, opts.where)\n  return mkdirp(path.dirname(dest))\n    .then(() => withTarballStream(spec, opts, stream => {\n      return rimraf(dest)\n        .then(() => new BB((resolve, reject) => {\n          const writer = fs.createWriteStream(dest)\n          stream.on('error', reject)\n          writer.on('error', reject)\n          writer.on('close', resolve)\n          stream.pipe(writer)\n        }))\n    }))\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}