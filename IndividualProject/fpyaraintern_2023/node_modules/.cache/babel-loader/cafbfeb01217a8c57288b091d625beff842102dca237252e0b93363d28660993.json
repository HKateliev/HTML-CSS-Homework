{"ast":null,"code":"'use strict';\n\nvar fs = require('graceful-fs');\nvar path = require('path');\nvar chain = require('slide').chain;\nvar iferr = require('iferr');\nvar rimraf = require('rimraf');\nvar mkdirp = require('gentle-fs').mkdir;\nvar rmStuff = require('../../unbuild.js').rmStuff;\nvar lifecycle = require('../../utils/lifecycle.js');\nvar move = require('../../utils/move.js');\n\n/*\n  Move a module from one point in the node_modules tree to another.\n  Do not disturb either the source or target location's node_modules\n  folders.\n*/\n\nmodule.exports = function (staging, pkg, log, next) {\n  log.silly('move', pkg.fromPath, pkg.path);\n  chain([[lifecycle, pkg.package, 'preuninstall', pkg.fromPath, {\n    failOk: true\n  }], [lifecycle, pkg.package, 'uninstall', pkg.fromPath, {\n    failOk: true\n  }], [rmStuff, pkg.package, pkg.fromPath], [lifecycle, pkg.package, 'postuninstall', pkg.fromPath, {\n    failOk: true\n  }], [moveModuleOnly, pkg.fromPath, pkg.path, log], [lifecycle, pkg.package, 'preinstall', pkg.path, {\n    failOk: true\n  }], [removeEmptyParents, path.resolve(pkg.fromPath, '..')]], next);\n};\nfunction removeEmptyParents(pkgdir, next) {\n  fs.rmdir(pkgdir, function (er) {\n    // FIXME: Make sure windows does what we want here\n    if (er && er.code !== 'ENOENT') return next();\n    removeEmptyParents(path.resolve(pkgdir, '..'), next);\n  });\n}\nfunction moveModuleOnly(from, to, log, done) {\n  var fromModules = path.join(from, 'node_modules');\n  var tempFromModules = from + '.node_modules';\n  var toModules = path.join(to, 'node_modules');\n  var tempToModules = to + '.node_modules';\n  log.silly('move', 'move existing destination node_modules away', toModules);\n  move(toModules, tempToModules).then(removeDestination(done), removeDestination(done));\n  function removeDestination(next) {\n    return function (er) {\n      log.silly('move', 'remove existing destination', to);\n      if (er) {\n        rimraf(to, iferr(next, makeDestination(next)));\n      } else {\n        rimraf(to, iferr(next, makeDestination(iferr(next, moveToModulesBack(next)))));\n      }\n    };\n  }\n  function moveToModulesBack(next) {\n    return function () {\n      log.silly('move', 'move existing destination node_modules back', toModules);\n      move(tempToModules, toModules).then(next, done);\n    };\n  }\n  function makeDestination(next) {\n    return function () {\n      log.silly('move', 'make sure destination parent exists', path.resolve(to, '..'));\n      mkdirp(path.resolve(to, '..'), iferr(done, moveNodeModules(next)));\n    };\n  }\n  function moveNodeModules(next) {\n    return function () {\n      log.silly('move', 'move source node_modules away', fromModules);\n      move(fromModules, tempFromModules).then(doMove(moveNodeModulesBack(next)), doMove(next));\n    };\n  }\n  function doMove(next) {\n    return function () {\n      log.silly('move', 'move module dir to final dest', from, to);\n      move(from, to).then(next, done);\n    };\n  }\n  function moveNodeModulesBack(next) {\n    return function () {\n      mkdirp(from, iferr(done, function () {\n        log.silly('move', 'put source node_modules back', fromModules);\n        move(tempFromModules, fromModules).then(next, done);\n      }));\n    };\n  }\n}","map":{"version":3,"names":["fs","require","path","chain","iferr","rimraf","mkdirp","mkdir","rmStuff","lifecycle","move","module","exports","staging","pkg","log","next","silly","fromPath","package","failOk","moveModuleOnly","removeEmptyParents","resolve","pkgdir","rmdir","er","code","from","to","done","fromModules","join","tempFromModules","toModules","tempToModules","then","removeDestination","makeDestination","moveToModulesBack","moveNodeModules","doMove","moveNodeModulesBack"],"sources":["/Users/hkateliev/node_modules/npm/lib/install/action/move.js"],"sourcesContent":["'use strict'\nvar fs = require('graceful-fs')\nvar path = require('path')\nvar chain = require('slide').chain\nvar iferr = require('iferr')\nvar rimraf = require('rimraf')\nvar mkdirp = require('gentle-fs').mkdir\nvar rmStuff = require('../../unbuild.js').rmStuff\nvar lifecycle = require('../../utils/lifecycle.js')\nvar move = require('../../utils/move.js')\n\n/*\n  Move a module from one point in the node_modules tree to another.\n  Do not disturb either the source or target location's node_modules\n  folders.\n*/\n\nmodule.exports = function (staging, pkg, log, next) {\n  log.silly('move', pkg.fromPath, pkg.path)\n  chain([\n    [lifecycle, pkg.package, 'preuninstall', pkg.fromPath, { failOk: true }],\n    [lifecycle, pkg.package, 'uninstall', pkg.fromPath, { failOk: true }],\n    [rmStuff, pkg.package, pkg.fromPath],\n    [lifecycle, pkg.package, 'postuninstall', pkg.fromPath, { failOk: true }],\n    [moveModuleOnly, pkg.fromPath, pkg.path, log],\n    [lifecycle, pkg.package, 'preinstall', pkg.path, { failOk: true }],\n    [removeEmptyParents, path.resolve(pkg.fromPath, '..')]\n  ], next)\n}\n\nfunction removeEmptyParents (pkgdir, next) {\n  fs.rmdir(pkgdir, function (er) {\n    // FIXME: Make sure windows does what we want here\n    if (er && er.code !== 'ENOENT') return next()\n    removeEmptyParents(path.resolve(pkgdir, '..'), next)\n  })\n}\n\nfunction moveModuleOnly (from, to, log, done) {\n  var fromModules = path.join(from, 'node_modules')\n  var tempFromModules = from + '.node_modules'\n  var toModules = path.join(to, 'node_modules')\n  var tempToModules = to + '.node_modules'\n\n  log.silly('move', 'move existing destination node_modules away', toModules)\n\n  move(toModules, tempToModules).then(removeDestination(done), removeDestination(done))\n\n  function removeDestination (next) {\n    return function (er) {\n      log.silly('move', 'remove existing destination', to)\n      if (er) {\n        rimraf(to, iferr(next, makeDestination(next)))\n      } else {\n        rimraf(to, iferr(next, makeDestination(iferr(next, moveToModulesBack(next)))))\n      }\n    }\n  }\n\n  function moveToModulesBack (next) {\n    return function () {\n      log.silly('move', 'move existing destination node_modules back', toModules)\n      move(tempToModules, toModules).then(next, done)\n    }\n  }\n\n  function makeDestination (next) {\n    return function () {\n      log.silly('move', 'make sure destination parent exists', path.resolve(to, '..'))\n      mkdirp(path.resolve(to, '..'), iferr(done, moveNodeModules(next)))\n    }\n  }\n\n  function moveNodeModules (next) {\n    return function () {\n      log.silly('move', 'move source node_modules away', fromModules)\n      move(fromModules, tempFromModules).then(doMove(moveNodeModulesBack(next)), doMove(next))\n    }\n  }\n\n  function doMove (next) {\n    return function () {\n      log.silly('move', 'move module dir to final dest', from, to)\n      move(from, to).then(next, done)\n    }\n  }\n\n  function moveNodeModulesBack (next) {\n    return function () {\n      mkdirp(from, iferr(done, function () {\n        log.silly('move', 'put source node_modules back', fromModules)\n        move(tempFromModules, fromModules).then(next, done)\n      }))\n    }\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}