{"ast":null,"code":"'use strict';\n\nconst BB = require('bluebird');\nconst figgyPudding = require('figgy-pudding');\nconst stat = BB.promisify(require('graceful-fs').stat);\nconst gentlyRm = BB.promisify(require('../../utils/gently-rm.js'));\nconst mkdirp = BB.promisify(require('gentle-fs').mkdir);\nconst moduleName = require('../../utils/module-name.js');\nconst moduleStagingPath = require('../module-staging-path.js');\nconst move = require('../../utils/move.js');\nconst npa = require('npm-package-arg');\nconst npm = require('../../npm.js');\nlet npmConfig;\nconst packageId = require('../../utils/package-id.js');\nconst path = require('path');\nconst localWorker = require('./extract-worker.js');\nconst workerFarm = require('worker-farm');\nconst isRegistry = require('../../utils/is-registry.js');\nconst WORKER_PATH = require.resolve('./extract-worker.js');\nlet workers;\nconst ExtractOpts = figgyPudding({\n  log: {}\n}, {\n  other() {\n    return true;\n  }\n});\n\n// Disabled for now. Re-enable someday. Just not today.\nconst ENABLE_WORKERS = false;\nextract.init = () => {\n  if (ENABLE_WORKERS) {\n    workers = workerFarm({\n      maxConcurrentCallsPerWorker: npm.limit.fetch,\n      maxRetries: 1\n    }, WORKER_PATH);\n  }\n  return BB.resolve();\n};\nextract.teardown = () => {\n  if (ENABLE_WORKERS) {\n    workerFarm.end(workers);\n    workers = null;\n  }\n  return BB.resolve();\n};\nmodule.exports = extract;\nfunction extract(staging, pkg, log) {\n  log.silly('extract', packageId(pkg));\n  const extractTo = moduleStagingPath(staging, pkg);\n  if (!npmConfig) {\n    npmConfig = require('../../config/figgy-config.js');\n  }\n  let opts = ExtractOpts(npmConfig()).concat({\n    integrity: pkg.package._integrity,\n    resolved: pkg.package._resolved\n  });\n  const args = [pkg.package._requested, extractTo, opts];\n  return BB.fromNode(cb => {\n    let launcher = localWorker;\n    let msg = args;\n    const spec = typeof args[0] === 'string' ? npa(args[0]) : args[0];\n    args[0] = spec.raw;\n    if (ENABLE_WORKERS && (isRegistry(spec) || spec.type === 'remote')) {\n      // We can't serialize these options\n      opts = opts.concat({\n        loglevel: opts.log.level,\n        log: null,\n        dirPacker: null,\n        Promise: null,\n        _events: null,\n        _eventsCount: null,\n        list: null,\n        sources: null,\n        _maxListeners: null,\n        root: null\n      });\n      // workers will run things in parallel!\n      launcher = workers;\n      try {\n        msg = JSON.stringify(msg);\n      } catch (e) {\n        return cb(e);\n      }\n    }\n    launcher(msg, cb);\n  }).then(() => {\n    if (pkg.package.bundleDependencies || anyBundled(pkg)) {\n      return readBundled(pkg, staging, extractTo);\n    }\n  }).then(() => {\n    return gentlyRm(path.join(extractTo, 'node_modules'));\n  });\n}\nfunction anyBundled(top, pkg) {\n  if (!pkg) pkg = top;\n  return pkg.children.some(child => child.fromBundle === top || anyBundled(top, child));\n}\nfunction readBundled(pkg, staging, extractTo) {\n  return BB.map(pkg.children, child => {\n    if (!child.fromBundle) return;\n    if (child.error) {\n      throw child.error;\n    } else {\n      return stageBundledModule(pkg, child, staging, extractTo);\n    }\n  }, {\n    concurrency: 10\n  });\n}\nfunction stageBundledModule(bundler, child, staging, parentPath) {\n  const stageFrom = path.join(parentPath, 'node_modules', moduleName(child));\n  const stageTo = moduleStagingPath(staging, child);\n  return BB.map(child.children, child => {\n    if (child.error) {\n      throw child.error;\n    } else {\n      return stageBundledModule(bundler, child, staging, stageFrom);\n    }\n  }).then(() => {\n    return finishModule(bundler, child, stageTo, stageFrom);\n  });\n}\nfunction finishModule(bundler, child, stageTo, stageFrom) {\n  // If we were the one's who bundled this module…\n  if (child.fromBundle === bundler) {\n    return mkdirp(path.dirname(stageTo)).then(() => {\n      return move(stageFrom, stageTo);\n    });\n  } else {\n    return stat(stageFrom).then(() => gentlyRm(stageFrom), () => {});\n  }\n}","map":{"version":3,"names":["BB","require","figgyPudding","stat","promisify","gentlyRm","mkdirp","mkdir","moduleName","moduleStagingPath","move","npa","npm","npmConfig","packageId","path","localWorker","workerFarm","isRegistry","WORKER_PATH","resolve","workers","ExtractOpts","log","other","ENABLE_WORKERS","extract","init","maxConcurrentCallsPerWorker","limit","fetch","maxRetries","teardown","end","module","exports","staging","pkg","silly","extractTo","opts","concat","integrity","package","_integrity","resolved","_resolved","args","_requested","fromNode","cb","launcher","msg","spec","raw","type","loglevel","level","dirPacker","Promise","_events","_eventsCount","list","sources","_maxListeners","root","JSON","stringify","e","then","bundleDependencies","anyBundled","readBundled","join","top","children","some","child","fromBundle","map","error","stageBundledModule","concurrency","bundler","parentPath","stageFrom","stageTo","finishModule","dirname"],"sources":["/Users/hkateliev/node_modules/npm/lib/install/action/extract.js"],"sourcesContent":["'use strict'\n\nconst BB = require('bluebird')\n\nconst figgyPudding = require('figgy-pudding')\nconst stat = BB.promisify(require('graceful-fs').stat)\nconst gentlyRm = BB.promisify(require('../../utils/gently-rm.js'))\nconst mkdirp = BB.promisify(require('gentle-fs').mkdir)\nconst moduleName = require('../../utils/module-name.js')\nconst moduleStagingPath = require('../module-staging-path.js')\nconst move = require('../../utils/move.js')\nconst npa = require('npm-package-arg')\nconst npm = require('../../npm.js')\nlet npmConfig\nconst packageId = require('../../utils/package-id.js')\nconst path = require('path')\nconst localWorker = require('./extract-worker.js')\nconst workerFarm = require('worker-farm')\nconst isRegistry = require('../../utils/is-registry.js')\n\nconst WORKER_PATH = require.resolve('./extract-worker.js')\nlet workers\n\nconst ExtractOpts = figgyPudding({\n  log: {}\n}, { other () { return true } })\n\n// Disabled for now. Re-enable someday. Just not today.\nconst ENABLE_WORKERS = false\n\nextract.init = () => {\n  if (ENABLE_WORKERS) {\n    workers = workerFarm({\n      maxConcurrentCallsPerWorker: npm.limit.fetch,\n      maxRetries: 1\n    }, WORKER_PATH)\n  }\n  return BB.resolve()\n}\nextract.teardown = () => {\n  if (ENABLE_WORKERS) {\n    workerFarm.end(workers)\n    workers = null\n  }\n  return BB.resolve()\n}\nmodule.exports = extract\nfunction extract (staging, pkg, log) {\n  log.silly('extract', packageId(pkg))\n  const extractTo = moduleStagingPath(staging, pkg)\n  if (!npmConfig) {\n    npmConfig = require('../../config/figgy-config.js')\n  }\n  let opts = ExtractOpts(npmConfig()).concat({\n    integrity: pkg.package._integrity,\n    resolved: pkg.package._resolved\n  })\n  const args = [\n    pkg.package._requested,\n    extractTo,\n    opts\n  ]\n  return BB.fromNode((cb) => {\n    let launcher = localWorker\n    let msg = args\n    const spec = typeof args[0] === 'string' ? npa(args[0]) : args[0]\n    args[0] = spec.raw\n    if (ENABLE_WORKERS && (isRegistry(spec) || spec.type === 'remote')) {\n      // We can't serialize these options\n      opts = opts.concat({\n        loglevel: opts.log.level,\n        log: null,\n        dirPacker: null,\n        Promise: null,\n        _events: null,\n        _eventsCount: null,\n        list: null,\n        sources: null,\n        _maxListeners: null,\n        root: null\n      })\n      // workers will run things in parallel!\n      launcher = workers\n      try {\n        msg = JSON.stringify(msg)\n      } catch (e) {\n        return cb(e)\n      }\n    }\n    launcher(msg, cb)\n  }).then(() => {\n    if (pkg.package.bundleDependencies || anyBundled(pkg)) {\n      return readBundled(pkg, staging, extractTo)\n    }\n  }).then(() => {\n    return gentlyRm(path.join(extractTo, 'node_modules'))\n  })\n}\n\nfunction anyBundled (top, pkg) {\n  if (!pkg) pkg = top\n  return pkg.children.some((child) => child.fromBundle === top || anyBundled(top, child))\n}\n\nfunction readBundled (pkg, staging, extractTo) {\n  return BB.map(pkg.children, (child) => {\n    if (!child.fromBundle) return\n    if (child.error) {\n      throw child.error\n    } else {\n      return stageBundledModule(pkg, child, staging, extractTo)\n    }\n  }, {concurrency: 10})\n}\n\nfunction stageBundledModule (bundler, child, staging, parentPath) {\n  const stageFrom = path.join(parentPath, 'node_modules', moduleName(child))\n  const stageTo = moduleStagingPath(staging, child)\n\n  return BB.map(child.children, (child) => {\n    if (child.error) {\n      throw child.error\n    } else {\n      return stageBundledModule(bundler, child, staging, stageFrom)\n    }\n  }).then(() => {\n    return finishModule(bundler, child, stageTo, stageFrom)\n  })\n}\n\nfunction finishModule (bundler, child, stageTo, stageFrom) {\n  // If we were the one's who bundled this module…\n  if (child.fromBundle === bundler) {\n    return mkdirp(path.dirname(stageTo)).then(() => {\n      return move(stageFrom, stageTo)\n    })\n  } else {\n    return stat(stageFrom).then(() => gentlyRm(stageFrom), () => {})\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}