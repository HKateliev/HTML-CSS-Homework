{"ast":null,"code":"module.exports = unbuild;\nmodule.exports.rmStuff = rmStuff;\nunbuild.usage = 'npm unbuild <folder>\\n(this is plumbing)';\nconst readJson = require('read-package-json');\nconst gentlyRm = require('./utils/gently-rm.js');\nconst npm = require('./npm.js');\nconst path = require('path');\nconst isInside = require('path-is-inside');\nconst lifecycle = require('./utils/lifecycle.js');\nconst asyncMap = require('slide').asyncMap;\nconst chain = require('slide').chain;\nconst log = require('npmlog');\nconst build = require('./build.js');\nconst output = require('./utils/output.js');\n\n// args is a list of folders.\n// remove any bins/etc, and then delete the folder.\nfunction unbuild(args, silent, cb) {\n  if (typeof silent === 'function') {\n    cb = silent;\n    silent = false;\n  }\n  asyncMap(args, unbuild_(silent), cb);\n}\nfunction unbuild_(silent) {\n  return function (folder, cb_) {\n    function cb(er) {\n      cb_(er, path.relative(npm.root, folder));\n    }\n    folder = path.resolve(folder);\n    const base = isInside(folder, npm.prefix) ? npm.prefix : folder;\n    delete build._didBuild[folder];\n    log.verbose('unbuild', folder.substr(npm.prefix.length + 1));\n    readJson(path.resolve(folder, 'package.json'), function (er, pkg) {\n      // if no json, then just trash it, but no scripts or whatever.\n      if (er) return gentlyRm(folder, false, base, cb);\n      chain([[lifecycle, pkg, 'preuninstall', folder, {\n        failOk: true\n      }], [lifecycle, pkg, 'uninstall', folder, {\n        failOk: true\n      }], !silent && function (cb) {\n        output('unbuild ' + pkg._id);\n        cb();\n      }, [rmStuff, pkg, folder], [lifecycle, pkg, 'postuninstall', folder, {\n        failOk: true\n      }], [gentlyRm, folder, false, base]], cb);\n    });\n  };\n}\nfunction rmStuff(pkg, folder, cb) {\n  // if it's global, and folder is in {prefix}/node_modules,\n  // then bins are in {prefix}/bin\n  // otherwise, then bins are in folder/../.bin\n  const dir = path.dirname(folder);\n  const scope = path.basename(dir);\n  const parent = scope.charAt(0) === '@' ? path.dirname(dir) : dir;\n  const gnm = npm.dir;\n  // gnm might be an absolute path, parent might be relative\n  // this checks they're the same directory regardless\n  const top = path.relative(gnm, parent) === '';\n  log.verbose('unbuild rmStuff', pkg._id, 'from', gnm);\n  if (!top) log.verbose('unbuild rmStuff', 'in', parent);\n  asyncMap([rmBins, rmMans], function (fn, cb) {\n    fn(pkg, folder, parent, top, cb);\n  }, cb);\n}\nfunction rmBins(pkg, folder, parent, top, cb) {\n  if (!pkg.bin) return cb();\n  const binRoot = top ? npm.bin : path.resolve(parent, '.bin');\n  asyncMap(Object.keys(pkg.bin), function (b, cb) {\n    if (process.platform === 'win32') {\n      chain([[gentlyRm, path.resolve(binRoot, b) + '.ps1', true, folder], [gentlyRm, path.resolve(binRoot, b) + '.cmd', true, folder], [gentlyRm, path.resolve(binRoot, b), true, folder]], cb);\n    } else {\n      gentlyRm(path.resolve(binRoot, b), true, folder, cb);\n    }\n  }, gentlyRmBinRoot);\n  function gentlyRmBinRoot(err) {\n    if (err || top) return cb(err);\n    return gentlyRm(binRoot, true, parent, cb);\n  }\n}\nfunction rmMans(pkg, folder, parent, top, cb) {\n  if (!pkg.man || !top || process.platform === 'win32' || !npm.config.get('global')) {\n    return cb();\n  }\n  const manRoot = path.resolve(npm.config.get('prefix'), 'share', 'man');\n  log.verbose('rmMans', 'man files are', pkg.man, 'in', manRoot);\n  asyncMap(pkg.man, function (man, cb) {\n    if (Array.isArray(man)) {\n      man.forEach(rmMan);\n    } else {\n      rmMan(man);\n    }\n    function rmMan(man) {\n      log.silly('rmMan', 'preparing to remove', man);\n      const parseMan = man.match(/(.*\\.([0-9]+)(\\.gz)?)$/);\n      if (!parseMan) {\n        log.error('rmMan', man, 'is not a valid name for a man file.', 'Man files must end with a number, ' + 'and optionally a .gz suffix if they are compressed.');\n        return cb();\n      }\n      const stem = parseMan[1];\n      const sxn = parseMan[2];\n      const gz = parseMan[3] || '';\n      const bn = path.basename(stem);\n      const manDest = path.join(manRoot, 'man' + sxn, (bn.indexOf(pkg.name) === 0 ? bn : pkg.name + '-' + bn) + '.' + sxn + gz);\n      gentlyRm(manDest, true, cb);\n    }\n  }, cb);\n}","map":{"version":3,"names":["module","exports","unbuild","rmStuff","usage","readJson","require","gentlyRm","npm","path","isInside","lifecycle","asyncMap","chain","log","build","output","args","silent","cb","unbuild_","folder","cb_","er","relative","root","resolve","base","prefix","_didBuild","verbose","substr","length","pkg","failOk","_id","dir","dirname","scope","basename","parent","charAt","gnm","top","rmBins","rmMans","fn","bin","binRoot","Object","keys","b","process","platform","gentlyRmBinRoot","err","man","config","get","manRoot","Array","isArray","forEach","rmMan","silly","parseMan","match","error","stem","sxn","gz","bn","manDest","join","indexOf","name"],"sources":["/Users/hkateliev/node_modules/npm/lib/unbuild.js"],"sourcesContent":["module.exports = unbuild\nmodule.exports.rmStuff = rmStuff\nunbuild.usage = 'npm unbuild <folder>\\n(this is plumbing)'\n\nconst readJson = require('read-package-json')\nconst gentlyRm = require('./utils/gently-rm.js')\nconst npm = require('./npm.js')\nconst path = require('path')\nconst isInside = require('path-is-inside')\nconst lifecycle = require('./utils/lifecycle.js')\nconst asyncMap = require('slide').asyncMap\nconst chain = require('slide').chain\nconst log = require('npmlog')\nconst build = require('./build.js')\nconst output = require('./utils/output.js')\n\n// args is a list of folders.\n// remove any bins/etc, and then delete the folder.\nfunction unbuild (args, silent, cb) {\n  if (typeof silent === 'function') {\n    cb = silent\n    silent = false\n  }\n  asyncMap(args, unbuild_(silent), cb)\n}\n\nfunction unbuild_ (silent) {\n  return function (folder, cb_) {\n    function cb (er) {\n      cb_(er, path.relative(npm.root, folder))\n    }\n    folder = path.resolve(folder)\n    const base = isInside(folder, npm.prefix) ? npm.prefix : folder\n    delete build._didBuild[folder]\n    log.verbose('unbuild', folder.substr(npm.prefix.length + 1))\n    readJson(path.resolve(folder, 'package.json'), function (er, pkg) {\n      // if no json, then just trash it, but no scripts or whatever.\n      if (er) return gentlyRm(folder, false, base, cb)\n      chain(\n        [\n          [lifecycle, pkg, 'preuninstall', folder, { failOk: true }],\n          [lifecycle, pkg, 'uninstall', folder, { failOk: true }],\n          !silent && function (cb) {\n            output('unbuild ' + pkg._id)\n            cb()\n          },\n          [rmStuff, pkg, folder],\n          [lifecycle, pkg, 'postuninstall', folder, { failOk: true }],\n          [gentlyRm, folder, false, base]\n        ],\n        cb\n      )\n    })\n  }\n}\n\nfunction rmStuff (pkg, folder, cb) {\n  // if it's global, and folder is in {prefix}/node_modules,\n  // then bins are in {prefix}/bin\n  // otherwise, then bins are in folder/../.bin\n  const dir = path.dirname(folder)\n  const scope = path.basename(dir)\n  const parent = scope.charAt(0) === '@' ? path.dirname(dir) : dir\n  const gnm = npm.dir\n  // gnm might be an absolute path, parent might be relative\n  // this checks they're the same directory regardless\n  const top = path.relative(gnm, parent) === ''\n\n  log.verbose('unbuild rmStuff', pkg._id, 'from', gnm)\n  if (!top) log.verbose('unbuild rmStuff', 'in', parent)\n  asyncMap([rmBins, rmMans], function (fn, cb) {\n    fn(pkg, folder, parent, top, cb)\n  }, cb)\n}\n\nfunction rmBins (pkg, folder, parent, top, cb) {\n  if (!pkg.bin) return cb()\n  const binRoot = top ? npm.bin : path.resolve(parent, '.bin')\n  asyncMap(Object.keys(pkg.bin), function (b, cb) {\n    if (process.platform === 'win32') {\n      chain([\n        [gentlyRm, path.resolve(binRoot, b) + '.ps1', true, folder],\n        [gentlyRm, path.resolve(binRoot, b) + '.cmd', true, folder],\n        [gentlyRm, path.resolve(binRoot, b), true, folder]\n      ], cb)\n    } else {\n      gentlyRm(path.resolve(binRoot, b), true, folder, cb)\n    }\n  }, gentlyRmBinRoot)\n\n  function gentlyRmBinRoot (err) {\n    if (err || top) return cb(err)\n    return gentlyRm(binRoot, true, parent, cb)\n  }\n}\n\nfunction rmMans (pkg, folder, parent, top, cb) {\n  if (!pkg.man ||\n      !top ||\n      process.platform === 'win32' ||\n      !npm.config.get('global')) {\n    return cb()\n  }\n  const manRoot = path.resolve(npm.config.get('prefix'), 'share', 'man')\n  log.verbose('rmMans', 'man files are', pkg.man, 'in', manRoot)\n  asyncMap(pkg.man, function (man, cb) {\n    if (Array.isArray(man)) {\n      man.forEach(rmMan)\n    } else {\n      rmMan(man)\n    }\n\n    function rmMan (man) {\n      log.silly('rmMan', 'preparing to remove', man)\n      const parseMan = man.match(/(.*\\.([0-9]+)(\\.gz)?)$/)\n      if (!parseMan) {\n        log.error(\n          'rmMan', man, 'is not a valid name for a man file.',\n          'Man files must end with a number, ' +\n          'and optionally a .gz suffix if they are compressed.'\n        )\n        return cb()\n      }\n\n      const stem = parseMan[1]\n      const sxn = parseMan[2]\n      const gz = parseMan[3] || ''\n      const bn = path.basename(stem)\n      const manDest = path.join(\n        manRoot,\n        'man' + sxn,\n        (bn.indexOf(pkg.name) === 0 ? bn : pkg.name + '-' + bn) + '.' + sxn + gz\n      )\n      gentlyRm(manDest, true, cb)\n    }\n  }, cb)\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}