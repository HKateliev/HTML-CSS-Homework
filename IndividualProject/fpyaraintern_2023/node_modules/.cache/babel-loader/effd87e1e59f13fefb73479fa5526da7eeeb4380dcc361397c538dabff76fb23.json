{"ast":null,"code":"var crypto = require('crypto');\nvar resolve = require('path').resolve;\nvar lockfile = require('lockfile');\nvar log = require('npmlog');\nvar npm = require('../npm.js');\nvar correctMkdir = require('../utils/correct-mkdir.js');\nvar installLocks = {};\nfunction lockFileName(base, name) {\n  var c = name.replace(/[^a-zA-Z0-9]+/g, '-').replace(/^-+|-+$/g, '');\n  var p = resolve(base, name);\n  var h = crypto.createHash('sha1').update(p).digest('hex');\n  var l = resolve(npm.cache, '_locks');\n  return resolve(l, c.substr(0, 24) + '-' + h.substr(0, 16) + '.lock');\n}\nfunction lock(base, name, cb) {\n  var lockDir = resolve(npm.cache, '_locks');\n  correctMkdir(lockDir, function (er) {\n    if (er) return cb(er);\n    var opts = {\n      stale: npm.config.get('cache-lock-stale'),\n      retries: npm.config.get('cache-lock-retries'),\n      wait: npm.config.get('cache-lock-wait')\n    };\n    var lf = lockFileName(base, name);\n    lockfile.lock(lf, opts, function (er) {\n      if (er) log.warn('locking', lf, 'failed', er);\n      if (!er) {\n        log.verbose('lock', 'using', lf, 'for', resolve(base, name));\n        installLocks[lf] = true;\n      }\n      cb(er);\n    });\n  });\n}\nfunction unlock(base, name, cb) {\n  var lf = lockFileName(base, name);\n  var locked = installLocks[lf];\n  if (locked === false) {\n    return process.nextTick(cb);\n  } else if (locked === true) {\n    lockfile.unlock(lf, function (er) {\n      if (er) {\n        log.warn('unlocking', lf, 'failed', er);\n      } else {\n        installLocks[lf] = false;\n        log.verbose('unlock', 'done using', lf, 'for', resolve(base, name));\n      }\n      cb(er);\n    });\n  } else {\n    var notLocked = new Error('Attempt to unlock ' + resolve(base, name) + \", which hasn't been locked\");\n    notLocked.code = 'ENOTLOCKED';\n    throw notLocked;\n  }\n}\nmodule.exports = {\n  lock: lock,\n  unlock: unlock\n};","map":{"version":3,"names":["crypto","require","resolve","lockfile","log","npm","correctMkdir","installLocks","lockFileName","base","name","c","replace","p","h","createHash","update","digest","l","cache","substr","lock","cb","lockDir","er","opts","stale","config","get","retries","wait","lf","warn","verbose","unlock","locked","process","nextTick","notLocked","Error","code","module","exports"],"sources":["/Users/hkateliev/node_modules/npm/lib/utils/locker.js"],"sourcesContent":["var crypto = require('crypto')\nvar resolve = require('path').resolve\n\nvar lockfile = require('lockfile')\nvar log = require('npmlog')\n\nvar npm = require('../npm.js')\nvar correctMkdir = require('../utils/correct-mkdir.js')\n\nvar installLocks = {}\n\nfunction lockFileName (base, name) {\n  var c = name.replace(/[^a-zA-Z0-9]+/g, '-').replace(/^-+|-+$/g, '')\n  var p = resolve(base, name)\n  var h = crypto.createHash('sha1').update(p).digest('hex')\n  var l = resolve(npm.cache, '_locks')\n\n  return resolve(l, c.substr(0, 24) + '-' + h.substr(0, 16) + '.lock')\n}\n\nfunction lock (base, name, cb) {\n  var lockDir = resolve(npm.cache, '_locks')\n  correctMkdir(lockDir, function (er) {\n    if (er) return cb(er)\n\n    var opts = {\n      stale: npm.config.get('cache-lock-stale'),\n      retries: npm.config.get('cache-lock-retries'),\n      wait: npm.config.get('cache-lock-wait')\n    }\n    var lf = lockFileName(base, name)\n    lockfile.lock(lf, opts, function (er) {\n      if (er) log.warn('locking', lf, 'failed', er)\n\n      if (!er) {\n        log.verbose('lock', 'using', lf, 'for', resolve(base, name))\n        installLocks[lf] = true\n      }\n\n      cb(er)\n    })\n  })\n}\n\nfunction unlock (base, name, cb) {\n  var lf = lockFileName(base, name)\n  var locked = installLocks[lf]\n  if (locked === false) {\n    return process.nextTick(cb)\n  } else if (locked === true) {\n    lockfile.unlock(lf, function (er) {\n      if (er) {\n        log.warn('unlocking', lf, 'failed', er)\n      } else {\n        installLocks[lf] = false\n        log.verbose('unlock', 'done using', lf, 'for', resolve(base, name))\n      }\n\n      cb(er)\n    })\n  } else {\n    var notLocked = new Error(\n      'Attempt to unlock ' + resolve(base, name) + \", which hasn't been locked\"\n    )\n    notLocked.code = 'ENOTLOCKED'\n    throw notLocked\n  }\n}\n\nmodule.exports = {\n  lock: lock,\n  unlock: unlock\n}\n"],"mappings":"AAAA,IAAIA,MAAM,GAAGC,OAAO,CAAC,QAAQ,CAAC;AAC9B,IAAIC,OAAO,GAAGD,OAAO,CAAC,MAAM,CAAC,CAACC,OAAO;AAErC,IAAIC,QAAQ,GAAGF,OAAO,CAAC,UAAU,CAAC;AAClC,IAAIG,GAAG,GAAGH,OAAO,CAAC,QAAQ,CAAC;AAE3B,IAAII,GAAG,GAAGJ,OAAO,CAAC,WAAW,CAAC;AAC9B,IAAIK,YAAY,GAAGL,OAAO,CAAC,2BAA2B,CAAC;AAEvD,IAAIM,YAAY,GAAG,CAAC,CAAC;AAErB,SAASC,YAAYA,CAAEC,IAAI,EAAEC,IAAI,EAAE;EACjC,IAAIC,CAAC,GAAGD,IAAI,CAACE,OAAO,CAAC,gBAAgB,EAAE,GAAG,CAAC,CAACA,OAAO,CAAC,UAAU,EAAE,EAAE,CAAC;EACnE,IAAIC,CAAC,GAAGX,OAAO,CAACO,IAAI,EAAEC,IAAI,CAAC;EAC3B,IAAII,CAAC,GAAGd,MAAM,CAACe,UAAU,CAAC,MAAM,CAAC,CAACC,MAAM,CAACH,CAAC,CAAC,CAACI,MAAM,CAAC,KAAK,CAAC;EACzD,IAAIC,CAAC,GAAGhB,OAAO,CAACG,GAAG,CAACc,KAAK,EAAE,QAAQ,CAAC;EAEpC,OAAOjB,OAAO,CAACgB,CAAC,EAAEP,CAAC,CAACS,MAAM,CAAC,CAAC,EAAE,EAAE,CAAC,GAAG,GAAG,GAAGN,CAAC,CAACM,MAAM,CAAC,CAAC,EAAE,EAAE,CAAC,GAAG,OAAO,CAAC;AACtE;AAEA,SAASC,IAAIA,CAAEZ,IAAI,EAAEC,IAAI,EAAEY,EAAE,EAAE;EAC7B,IAAIC,OAAO,GAAGrB,OAAO,CAACG,GAAG,CAACc,KAAK,EAAE,QAAQ,CAAC;EAC1Cb,YAAY,CAACiB,OAAO,EAAE,UAAUC,EAAE,EAAE;IAClC,IAAIA,EAAE,EAAE,OAAOF,EAAE,CAACE,EAAE,CAAC;IAErB,IAAIC,IAAI,GAAG;MACTC,KAAK,EAAErB,GAAG,CAACsB,MAAM,CAACC,GAAG,CAAC,kBAAkB,CAAC;MACzCC,OAAO,EAAExB,GAAG,CAACsB,MAAM,CAACC,GAAG,CAAC,oBAAoB,CAAC;MAC7CE,IAAI,EAAEzB,GAAG,CAACsB,MAAM,CAACC,GAAG,CAAC,iBAAiB;IACxC,CAAC;IACD,IAAIG,EAAE,GAAGvB,YAAY,CAACC,IAAI,EAAEC,IAAI,CAAC;IACjCP,QAAQ,CAACkB,IAAI,CAACU,EAAE,EAAEN,IAAI,EAAE,UAAUD,EAAE,EAAE;MACpC,IAAIA,EAAE,EAAEpB,GAAG,CAAC4B,IAAI,CAAC,SAAS,EAAED,EAAE,EAAE,QAAQ,EAAEP,EAAE,CAAC;MAE7C,IAAI,CAACA,EAAE,EAAE;QACPpB,GAAG,CAAC6B,OAAO,CAAC,MAAM,EAAE,OAAO,EAAEF,EAAE,EAAE,KAAK,EAAE7B,OAAO,CAACO,IAAI,EAAEC,IAAI,CAAC,CAAC;QAC5DH,YAAY,CAACwB,EAAE,CAAC,GAAG,IAAI;MACzB;MAEAT,EAAE,CAACE,EAAE,CAAC;IACR,CAAC,CAAC;EACJ,CAAC,CAAC;AACJ;AAEA,SAASU,MAAMA,CAAEzB,IAAI,EAAEC,IAAI,EAAEY,EAAE,EAAE;EAC/B,IAAIS,EAAE,GAAGvB,YAAY,CAACC,IAAI,EAAEC,IAAI,CAAC;EACjC,IAAIyB,MAAM,GAAG5B,YAAY,CAACwB,EAAE,CAAC;EAC7B,IAAII,MAAM,KAAK,KAAK,EAAE;IACpB,OAAOC,OAAO,CAACC,QAAQ,CAACf,EAAE,CAAC;EAC7B,CAAC,MAAM,IAAIa,MAAM,KAAK,IAAI,EAAE;IAC1BhC,QAAQ,CAAC+B,MAAM,CAACH,EAAE,EAAE,UAAUP,EAAE,EAAE;MAChC,IAAIA,EAAE,EAAE;QACNpB,GAAG,CAAC4B,IAAI,CAAC,WAAW,EAAED,EAAE,EAAE,QAAQ,EAAEP,EAAE,CAAC;MACzC,CAAC,MAAM;QACLjB,YAAY,CAACwB,EAAE,CAAC,GAAG,KAAK;QACxB3B,GAAG,CAAC6B,OAAO,CAAC,QAAQ,EAAE,YAAY,EAAEF,EAAE,EAAE,KAAK,EAAE7B,OAAO,CAACO,IAAI,EAAEC,IAAI,CAAC,CAAC;MACrE;MAEAY,EAAE,CAACE,EAAE,CAAC;IACR,CAAC,CAAC;EACJ,CAAC,MAAM;IACL,IAAIc,SAAS,GAAG,IAAIC,KAAK,CACvB,oBAAoB,GAAGrC,OAAO,CAACO,IAAI,EAAEC,IAAI,CAAC,GAAG,4BAA4B,CAC1E;IACD4B,SAAS,CAACE,IAAI,GAAG,YAAY;IAC7B,MAAMF,SAAS;EACjB;AACF;AAEAG,MAAM,CAACC,OAAO,GAAG;EACfrB,IAAI,EAAEA,IAAI;EACVa,MAAM,EAAEA;AACV,CAAC"},"metadata":{},"sourceType":"script","externalDependencies":[]}