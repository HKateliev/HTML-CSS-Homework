{"ast":null,"code":"'use strict';\n\nvar path = require('path');\nvar log = require('npmlog');\nvar validate = require('aproba');\nvar uniq = require('lodash.uniq');\nvar asyncMap = require('slide').asyncMap;\nvar npm = require('../npm.js');\nvar exists = require('./exists.js');\nvar writable = require('./writable.js');\nmodule.exports = function (actions, next) {\n  validate('AF', arguments);\n  var errors = [];\n  asyncMap(actions, function (action, done) {\n    var cmd = action[0];\n    var pkg = action[1];\n    switch (cmd) {\n      case 'add':\n        hasAnyWriteAccess(path.resolve(pkg.path, '..'), errors, done);\n        break;\n      case 'update':\n      case 'remove':\n        hasWriteAccess(pkg.path, errors, andHasWriteAccess(path.resolve(pkg.path, '..'), errors, done));\n        break;\n      case 'move':\n        hasAnyWriteAccess(pkg.path, errors, andHasWriteAccess(path.resolve(pkg.fromPath, '..'), errors, done));\n        break;\n      default:\n        done();\n    }\n  }, function () {\n    if (!errors.length) return next();\n    uniq(errors.map(function (er) {\n      return 'Missing write access to ' + er.path;\n    })).forEach(function (er) {\n      log.warn('checkPermissions', er);\n    });\n    npm.config.get('force') ? next() : next(errors[0]);\n  });\n};\nfunction andHasWriteAccess(dir, errors, done) {\n  validate('SAF', arguments);\n  return function () {\n    hasWriteAccess(dir, errors, done);\n  };\n}\nfunction hasAnyWriteAccess(dir, errors, done) {\n  validate('SAF', arguments);\n  findNearestDir();\n  function findNearestDir() {\n    var nextDir = path.resolve(dir, '..');\n    exists(dir, function (dirDoesntExist) {\n      if (!dirDoesntExist || nextDir === dir) {\n        return hasWriteAccess(dir, errors, done);\n      } else {\n        dir = nextDir;\n        findNearestDir();\n      }\n    });\n  }\n}\nfunction hasWriteAccess(dir, errors, done) {\n  validate('SAF', arguments);\n  writable(dir, function (er) {\n    if (er) errors.push(er);\n    done();\n  });\n}","map":{"version":3,"names":["path","require","log","validate","uniq","asyncMap","npm","exists","writable","module","exports","actions","next","arguments","errors","action","done","cmd","pkg","hasAnyWriteAccess","resolve","hasWriteAccess","andHasWriteAccess","fromPath","length","map","er","forEach","warn","config","get","dir","findNearestDir","nextDir","dirDoesntExist","push"],"sources":["/Users/hkateliev/node_modules/npm/lib/install/check-permissions.js"],"sourcesContent":["'use strict'\nvar path = require('path')\nvar log = require('npmlog')\nvar validate = require('aproba')\nvar uniq = require('lodash.uniq')\nvar asyncMap = require('slide').asyncMap\nvar npm = require('../npm.js')\nvar exists = require('./exists.js')\nvar writable = require('./writable.js')\n\nmodule.exports = function (actions, next) {\n  validate('AF', arguments)\n  var errors = []\n  asyncMap(actions, function (action, done) {\n    var cmd = action[0]\n    var pkg = action[1]\n    switch (cmd) {\n      case 'add':\n        hasAnyWriteAccess(path.resolve(pkg.path, '..'), errors, done)\n        break\n      case 'update':\n      case 'remove':\n        hasWriteAccess(pkg.path, errors, andHasWriteAccess(path.resolve(pkg.path, '..'), errors, done))\n        break\n      case 'move':\n        hasAnyWriteAccess(pkg.path, errors, andHasWriteAccess(path.resolve(pkg.fromPath, '..'), errors, done))\n        break\n      default:\n        done()\n    }\n  }, function () {\n    if (!errors.length) return next()\n    uniq(errors.map(function (er) { return 'Missing write access to ' + er.path })).forEach(function (er) {\n      log.warn('checkPermissions', er)\n    })\n    npm.config.get('force') ? next() : next(errors[0])\n  })\n}\n\nfunction andHasWriteAccess (dir, errors, done) {\n  validate('SAF', arguments)\n  return function () {\n    hasWriteAccess(dir, errors, done)\n  }\n}\n\nfunction hasAnyWriteAccess (dir, errors, done) {\n  validate('SAF', arguments)\n  findNearestDir()\n  function findNearestDir () {\n    var nextDir = path.resolve(dir, '..')\n    exists(dir, function (dirDoesntExist) {\n      if (!dirDoesntExist || nextDir === dir) {\n        return hasWriteAccess(dir, errors, done)\n      } else {\n        dir = nextDir\n        findNearestDir()\n      }\n    })\n  }\n}\n\nfunction hasWriteAccess (dir, errors, done) {\n  validate('SAF', arguments)\n  writable(dir, function (er) {\n    if (er) errors.push(er)\n    done()\n  })\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}