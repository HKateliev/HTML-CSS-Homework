{"ast":null,"code":"// npm build command\n\n// everything about the installation after the creation of\n// the .npm/{name}/{version}/package folder.\n// linking the modules into the npm.root,\n// resolving dependencies, etc.\n\n// This runs AFTER install or link are completed.\n\nvar npm = require('./npm.js');\nvar log = require('npmlog');\nvar chain = require('slide').chain;\nvar path = require('path');\nvar fs = require('graceful-fs');\nvar lifecycle = require('./utils/lifecycle.js');\nvar readJson = require('read-package-json');\nvar binLinks = require('bin-links');\nvar binLinksConfig = require('./config/bin-links.js');\nvar ini = require('ini');\nvar writeFile = require('write-file-atomic');\nmodule.exports = build;\nbuild.usage = 'npm build [<folder>]';\nbuild._didBuild = {};\nbuild._noLC = {};\nfunction build(args, global, didPre, didRB, cb) {\n  if (typeof cb !== 'function') {\n    cb = didRB;\n    didRB = false;\n  }\n  if (typeof cb !== 'function') {\n    cb = didPre;\n    didPre = false;\n  }\n  if (typeof cb !== 'function') {\n    cb = global;\n    global = npm.config.get('global');\n  }\n  if (!args.length) {\n    readJson(path.resolve(npm.localPrefix, 'package.json'), function (er, pkg) {\n      if (!args.length && pkg && pkg.scripts && pkg.scripts.build) {\n        log.warn('build', '`npm build` called with no arguments. Did you mean to `npm run-script build`?');\n      }\n      cb();\n    });\n  } else {\n    // it'd be nice to asyncMap these, but actually, doing them\n    // in parallel generally munges up the output from node-waf\n    var builder = build_(global, didPre, didRB);\n    chain(args.map(function (arg) {\n      return function (cb) {\n        builder(arg, cb);\n      };\n    }), cb);\n  }\n}\nfunction build_(global, didPre, didRB) {\n  return function (folder, cb) {\n    folder = path.resolve(folder);\n    if (build._didBuild[folder]) log.info('build', 'already built', folder);\n    build._didBuild[folder] = true;\n    log.info('build', folder);\n    readJson(path.resolve(folder, 'package.json'), function (er, pkg) {\n      if (er) return cb(er);\n      chain([!didPre && [lifecycle, pkg, 'preinstall', folder], [linkStuff, pkg, folder, global], !didRB && [rebuildBundles, pkg, folder], [writeBuiltinConf, pkg, folder], didPre !== build._noLC && [lifecycle, pkg, 'install', folder], didPre !== build._noLC && [lifecycle, pkg, 'postinstall', folder]], cb);\n    });\n  };\n}\nvar writeBuiltinConf = build.writeBuiltinConf = function (pkg, folder, cb) {\n  // the builtin config is \"sticky\". Any time npm installs\n  // itself globally, it puts its builtin config file there\n  var parent = path.dirname(folder);\n  var dir = npm.globalDir;\n\n  // Make this count for canary, too\n  if (pkg.name !== 'npm' && pkg.name !== 'npmc' || !npm.config.get('global') || !npm.config.usingBuiltin || dir !== parent) {\n    return cb();\n  }\n  var data = ini.stringify(npm.config.sources.builtin.data);\n  writeFile(path.resolve(folder, 'npmrc'), data, cb);\n};\nvar linkStuff = build.linkStuff = function (pkg, folder, global, cb) {\n  // allow to opt out of linking binaries.\n  if (npm.config.get('bin-links') === false) return cb();\n  return binLinks(pkg, folder, global, binLinksConfig(pkg), cb);\n};\nfunction rebuildBundles(pkg, folder, cb) {\n  if (!npm.config.get('rebuild-bundle')) return cb();\n  var deps = Object.keys(pkg.dependencies || {}).concat(Object.keys(pkg.devDependencies || {}));\n  var bundles = pkg.bundleDependencies || pkg.bundledDependencies || [];\n  fs.readdir(path.resolve(folder, 'node_modules'), function (er, files) {\n    // error means no bundles\n    if (er) return cb();\n    log.verbose('rebuildBundles', files);\n    // don't asyncMap these, because otherwise build script output\n    // gets interleaved and is impossible to read\n    chain(files.filter(function (file) {\n      // rebuild if:\n      // not a .folder, like .bin or .hooks\n      return !file.match(/^[._-]/) &&\n      // not some old 0.x style bundle\n      file.indexOf('@') === -1 && (\n      // either not a dep, or explicitly bundled\n      deps.indexOf(file) === -1 || bundles.indexOf(file) !== -1);\n    }).map(function (file) {\n      file = path.resolve(folder, 'node_modules', file);\n      return function (cb) {\n        if (build._didBuild[file]) return cb();\n        log.verbose('rebuild bundle', file);\n        // if file is not a package dir, then don't do it.\n        fs.lstat(path.resolve(file, 'package.json'), function (er) {\n          if (er) return cb();\n          build_(false)(file, cb);\n        });\n      };\n    }), cb);\n  });\n}","map":{"version":3,"names":["npm","require","log","chain","path","fs","lifecycle","readJson","binLinks","binLinksConfig","ini","writeFile","module","exports","build","usage","_didBuild","_noLC","args","global","didPre","didRB","cb","config","get","length","resolve","localPrefix","er","pkg","scripts","warn","builder","build_","map","arg","folder","info","linkStuff","rebuildBundles","writeBuiltinConf","parent","dirname","dir","globalDir","name","usingBuiltin","data","stringify","sources","builtin","deps","Object","keys","dependencies","concat","devDependencies","bundles","bundleDependencies","bundledDependencies","readdir","files","verbose","filter","file","match","indexOf","lstat"],"sources":["/Users/hkateliev/node_modules/npm/lib/build.js"],"sourcesContent":["// npm build command\n\n// everything about the installation after the creation of\n// the .npm/{name}/{version}/package folder.\n// linking the modules into the npm.root,\n// resolving dependencies, etc.\n\n// This runs AFTER install or link are completed.\n\nvar npm = require('./npm.js')\nvar log = require('npmlog')\nvar chain = require('slide').chain\nvar path = require('path')\nvar fs = require('graceful-fs')\nvar lifecycle = require('./utils/lifecycle.js')\nvar readJson = require('read-package-json')\nvar binLinks = require('bin-links')\nvar binLinksConfig = require('./config/bin-links.js')\nvar ini = require('ini')\nvar writeFile = require('write-file-atomic')\n\nmodule.exports = build\nbuild.usage = 'npm build [<folder>]'\n\nbuild._didBuild = {}\nbuild._noLC = {}\nfunction build (args, global, didPre, didRB, cb) {\n  if (typeof cb !== 'function') {\n    cb = didRB\n    didRB = false\n  }\n  if (typeof cb !== 'function') {\n    cb = didPre\n    didPre = false\n  }\n  if (typeof cb !== 'function') {\n    cb = global\n    global = npm.config.get('global')\n  }\n\n  if (!args.length) {\n    readJson(path.resolve(npm.localPrefix, 'package.json'), function (er, pkg) {\n      if (!args.length && pkg && pkg.scripts && pkg.scripts.build) {\n        log.warn('build', '`npm build` called with no arguments. Did you mean to `npm run-script build`?')\n      }\n      cb()\n    })\n  } else {\n    // it'd be nice to asyncMap these, but actually, doing them\n    // in parallel generally munges up the output from node-waf\n    var builder = build_(global, didPre, didRB)\n    chain(args.map(function (arg) {\n      return function (cb) {\n        builder(arg, cb)\n      }\n    }), cb)\n  }\n}\n\nfunction build_ (global, didPre, didRB) {\n  return function (folder, cb) {\n    folder = path.resolve(folder)\n    if (build._didBuild[folder]) log.info('build', 'already built', folder)\n    build._didBuild[folder] = true\n    log.info('build', folder)\n    readJson(path.resolve(folder, 'package.json'), function (er, pkg) {\n      if (er) return cb(er)\n      chain([\n        !didPre && [lifecycle, pkg, 'preinstall', folder],\n        [linkStuff, pkg, folder, global],\n        !didRB && [rebuildBundles, pkg, folder],\n        [writeBuiltinConf, pkg, folder],\n        didPre !== build._noLC && [lifecycle, pkg, 'install', folder],\n        didPre !== build._noLC && [lifecycle, pkg, 'postinstall', folder]\n      ],\n      cb)\n    })\n  }\n}\n\nvar writeBuiltinConf = build.writeBuiltinConf = function (pkg, folder, cb) {\n  // the builtin config is \"sticky\". Any time npm installs\n  // itself globally, it puts its builtin config file there\n  var parent = path.dirname(folder)\n  var dir = npm.globalDir\n\n  // Make this count for canary, too\n  if ((pkg.name !== 'npm' && pkg.name !== 'npmc') ||\n      !npm.config.get('global') ||\n      !npm.config.usingBuiltin ||\n      dir !== parent) {\n    return cb()\n  }\n\n  var data = ini.stringify(npm.config.sources.builtin.data)\n  writeFile(path.resolve(folder, 'npmrc'), data, cb)\n}\n\nvar linkStuff = build.linkStuff = function (pkg, folder, global, cb) {\n  // allow to opt out of linking binaries.\n  if (npm.config.get('bin-links') === false) return cb()\n  return binLinks(pkg, folder, global, binLinksConfig(pkg), cb)\n}\n\nfunction rebuildBundles (pkg, folder, cb) {\n  if (!npm.config.get('rebuild-bundle')) return cb()\n\n  var deps = Object.keys(pkg.dependencies || {})\n    .concat(Object.keys(pkg.devDependencies || {}))\n  var bundles = pkg.bundleDependencies || pkg.bundledDependencies || []\n\n  fs.readdir(path.resolve(folder, 'node_modules'), function (er, files) {\n    // error means no bundles\n    if (er) return cb()\n\n    log.verbose('rebuildBundles', files)\n    // don't asyncMap these, because otherwise build script output\n    // gets interleaved and is impossible to read\n    chain(files.filter(function (file) {\n      // rebuild if:\n      // not a .folder, like .bin or .hooks\n      return !file.match(/^[._-]/) &&\n          // not some old 0.x style bundle\n          file.indexOf('@') === -1 &&\n          // either not a dep, or explicitly bundled\n          (deps.indexOf(file) === -1 || bundles.indexOf(file) !== -1)\n    }).map(function (file) {\n      file = path.resolve(folder, 'node_modules', file)\n      return function (cb) {\n        if (build._didBuild[file]) return cb()\n        log.verbose('rebuild bundle', file)\n        // if file is not a package dir, then don't do it.\n        fs.lstat(path.resolve(file, 'package.json'), function (er) {\n          if (er) return cb()\n          build_(false)(file, cb)\n        })\n      }\n    }), cb)\n  })\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}