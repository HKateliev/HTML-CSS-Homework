{"ast":null,"code":"'use strict';\n\nvar path = require('path');\nvar validate = require('aproba');\nvar asyncMap = require('slide').asyncMap;\nvar chain = require('slide').chain;\nvar npmInstallChecks = require('npm-install-checks');\nvar checkGit = npmInstallChecks.checkGit;\nvar clone = require('lodash.clonedeep');\nvar normalizePackageData = require('normalize-package-data');\nvar npm = require('../npm.js');\nvar andFinishTracker = require('./and-finish-tracker.js');\nvar flattenTree = require('./flatten-tree.js');\nvar validateAllPeerDeps = require('./deps.js').validateAllPeerDeps;\nvar packageId = require('../utils/package-id.js');\nmodule.exports = function (idealTree, log, next) {\n  validate('OOF', arguments);\n  var moduleMap = flattenTree(idealTree);\n  var modules = Object.keys(moduleMap).map(function (name) {\n    return moduleMap[name];\n  });\n  chain([[asyncMap, modules, function (mod, done) {\n    chain([mod.parent && !mod.isLink && [checkGit, mod.realpath], [checkErrors, mod, idealTree]], done);\n  }], [thenValidateAllPeerDeps, idealTree], [thenCheckTop, idealTree], [thenCheckDuplicateDeps, idealTree]], andFinishTracker(log, next));\n};\nfunction checkErrors(mod, idealTree, next) {\n  if (mod.error && (mod.parent || path.resolve(npm.globalDir, '..') !== mod.path)) idealTree.warnings.push(mod.error);\n  next();\n}\nfunction thenValidateAllPeerDeps(idealTree, next) {\n  validate('OF', arguments);\n  validateAllPeerDeps(idealTree, function (tree, pkgname, version) {\n    var warn = new Error(packageId(tree) + ' requires a peer of ' + pkgname + '@' + version + ' but none is installed. You must install peer dependencies yourself.');\n    warn.code = 'EPEERINVALID';\n    idealTree.warnings.push(warn);\n  });\n  next();\n}\nfunction thenCheckTop(idealTree, next) {\n  validate('OF', arguments);\n  if (idealTree.package.error) return next();\n\n  // FIXME: when we replace read-package-json with something less magic,\n  // this should done elsewhere.\n  // As it is, the package has already been normalized and thus some\n  // errors are suppressed.\n  var pkg = clone(idealTree.package);\n  try {\n    normalizePackageData(pkg, function (warn) {\n      var warnObj = new Error(packageId(idealTree) + ' ' + warn);\n      warnObj.code = 'EPACKAGEJSON';\n      idealTree.warnings.push(warnObj);\n    }, false);\n  } catch (er) {\n    er.code = 'EPACKAGEJSON';\n    idealTree.warnings.push(er);\n  }\n  var nodeVersion = npm.config.get('node-version');\n  if (/-/.test(nodeVersion)) {\n    // if this is a prerelease node…\n    var warnObj = new Error('You are using a pre-release version of node and things may not work as expected');\n    warnObj.code = 'ENODEPRE';\n    idealTree.warnings.push(warnObj);\n  }\n  next();\n}\n\n// check for deps duplciated between devdeps and regular deps\nfunction thenCheckDuplicateDeps(idealTree, next) {\n  var deps = idealTree.package.dependencies || {};\n  var devDeps = idealTree.package.devDependencies || {};\n  for (var pkg in devDeps) {\n    if (pkg in deps) {\n      var warnObj = new Error('The package ' + pkg + ' is included as both a dev and production dependency.');\n      warnObj.code = 'EDUPLICATEDEP';\n      idealTree.warnings.push(warnObj);\n    }\n  }\n  next();\n}","map":{"version":3,"names":["path","require","validate","asyncMap","chain","npmInstallChecks","checkGit","clone","normalizePackageData","npm","andFinishTracker","flattenTree","validateAllPeerDeps","packageId","module","exports","idealTree","log","next","arguments","moduleMap","modules","Object","keys","map","name","mod","done","parent","isLink","realpath","checkErrors","thenValidateAllPeerDeps","thenCheckTop","thenCheckDuplicateDeps","error","resolve","globalDir","warnings","push","tree","pkgname","version","warn","Error","code","package","pkg","warnObj","er","nodeVersion","config","get","test","deps","dependencies","devDeps","devDependencies"],"sources":["/Users/hkateliev/node_modules/npm/lib/install/validate-tree.js"],"sourcesContent":["'use strict'\nvar path = require('path')\nvar validate = require('aproba')\nvar asyncMap = require('slide').asyncMap\nvar chain = require('slide').chain\nvar npmInstallChecks = require('npm-install-checks')\nvar checkGit = npmInstallChecks.checkGit\nvar clone = require('lodash.clonedeep')\nvar normalizePackageData = require('normalize-package-data')\nvar npm = require('../npm.js')\nvar andFinishTracker = require('./and-finish-tracker.js')\nvar flattenTree = require('./flatten-tree.js')\nvar validateAllPeerDeps = require('./deps.js').validateAllPeerDeps\nvar packageId = require('../utils/package-id.js')\n\nmodule.exports = function (idealTree, log, next) {\n  validate('OOF', arguments)\n  var moduleMap = flattenTree(idealTree)\n  var modules = Object.keys(moduleMap).map(function (name) { return moduleMap[name] })\n\n  chain([\n    [asyncMap, modules, function (mod, done) {\n      chain([\n        mod.parent && !mod.isLink && [checkGit, mod.realpath],\n        [checkErrors, mod, idealTree]\n      ], done)\n    }],\n    [thenValidateAllPeerDeps, idealTree],\n    [thenCheckTop, idealTree],\n    [thenCheckDuplicateDeps, idealTree]\n  ], andFinishTracker(log, next))\n}\n\nfunction checkErrors (mod, idealTree, next) {\n  if (mod.error && (mod.parent || path.resolve(npm.globalDir, '..') !== mod.path)) idealTree.warnings.push(mod.error)\n  next()\n}\n\nfunction thenValidateAllPeerDeps (idealTree, next) {\n  validate('OF', arguments)\n  validateAllPeerDeps(idealTree, function (tree, pkgname, version) {\n    var warn = new Error(packageId(tree) + ' requires a peer of ' + pkgname + '@' +\n      version + ' but none is installed. You must install peer dependencies yourself.')\n    warn.code = 'EPEERINVALID'\n    idealTree.warnings.push(warn)\n  })\n  next()\n}\n\nfunction thenCheckTop (idealTree, next) {\n  validate('OF', arguments)\n  if (idealTree.package.error) return next()\n\n  // FIXME: when we replace read-package-json with something less magic,\n  // this should done elsewhere.\n  // As it is, the package has already been normalized and thus some\n  // errors are suppressed.\n  var pkg = clone(idealTree.package)\n  try {\n    normalizePackageData(pkg, function (warn) {\n      var warnObj = new Error(packageId(idealTree) + ' ' + warn)\n      warnObj.code = 'EPACKAGEJSON'\n      idealTree.warnings.push(warnObj)\n    }, false)\n  } catch (er) {\n    er.code = 'EPACKAGEJSON'\n    idealTree.warnings.push(er)\n  }\n\n  var nodeVersion = npm.config.get('node-version')\n  if (/-/.test(nodeVersion)) {\n    // if this is a prerelease node…\n    var warnObj = new Error('You are using a pre-release version of node and things may not work as expected')\n    warnObj.code = 'ENODEPRE'\n    idealTree.warnings.push(warnObj)\n  }\n\n  next()\n}\n\n// check for deps duplciated between devdeps and regular deps\nfunction thenCheckDuplicateDeps (idealTree, next) {\n  var deps = idealTree.package.dependencies || {}\n  var devDeps = idealTree.package.devDependencies || {}\n\n  for (var pkg in devDeps) {\n    if (pkg in deps) {\n      var warnObj = new Error('The package ' + pkg + ' is included as both a dev and production dependency.')\n      warnObj.code = 'EDUPLICATEDEP'\n      idealTree.warnings.push(warnObj)\n    }\n  }\n\n  next()\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}