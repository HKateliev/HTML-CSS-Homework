{"ast":null,"code":"'use strict';\n\nconst BB = require('bluebird');\nconst fetch = require('npm-registry-fetch');\nconst LRU = require('lru-cache');\nconst optCheck = require('../../util/opt-check');\n\n// Corgis are cute. ðŸ•ðŸ¶\nconst CORGI_DOC = 'application/vnd.npm.install-v1+json; q=1.0, application/json; q=0.8, */*';\nconst JSON_DOC = 'application/json';\nmodule.exports = packument;\nfunction packument(spec, opts) {\n  opts = optCheck(opts);\n  const registry = fetch.pickRegistry(spec, opts);\n  const uri = registry.replace(/\\/?$/, '/') + spec.escapedName;\n  return fetchPackument(uri, registry, spec, opts);\n}\nconst MEMO = new LRU({\n  length: m => m._contentLength,\n  max: 200 * 1024 * 1024,\n  // 200MB\n  maxAge: 30 * 1000 // 30s\n});\n\nmodule.exports.clearMemoized = clearMemoized;\nfunction clearMemoized() {\n  MEMO.reset();\n}\nfunction fetchPackument(uri, registry, spec, opts) {\n  const mem = pickMem(opts);\n  const accept = opts.fullMetadata ? JSON_DOC : CORGI_DOC;\n  const memoKey = `${uri}~(${accept})`;\n  if (mem && !opts.preferOnline && mem.has(memoKey)) {\n    return BB.resolve(mem.get(memoKey));\n  }\n  return fetch(uri, opts.concat({\n    headers: {\n      'pacote-req-type': 'packument',\n      'pacote-pkg-id': `registry:${spec.name}`,\n      accept\n    },\n    spec\n  }, opts, {\n    // Force integrity to null: we never check integrity hashes for manifests\n    integrity: null\n  })).then(res => res.json().then(packument => {\n    packument._cached = res.headers.has('x-local-cache');\n    packument._contentLength = +res.headers.get('content-length');\n    // NOTE - we need to call pickMem again because proxy\n    //        objects get reused!\n    const mem = pickMem(opts);\n    if (mem) {\n      mem.set(memoKey, packument);\n    }\n    return packument;\n  })).catch(err => {\n    if (err.code === 'E404' && !opts.fullMetadata) {\n      return fetchPackument(uri, registry, spec, opts.concat({\n        fullMetadata: true\n      }));\n    } else {\n      throw err;\n    }\n  });\n}\nclass ObjProxy {\n  get(key) {\n    return this.obj[key];\n  }\n  set(key, val) {\n    this.obj[key] = val;\n  }\n}\n\n// This object is used synchronously and immediately, so\n// we can safely reuse it instead of consing up new ones\nconst PROX = new ObjProxy();\nfunction pickMem(opts) {\n  if (!opts || !opts.memoize) {\n    return MEMO;\n  } else if (opts.memoize.get && opts.memoize.set) {\n    return opts.memoize;\n  } else if (typeof opts.memoize === 'object') {\n    PROX.obj = opts.memoize;\n    return PROX;\n  } else {\n    return null;\n  }\n}","map":{"version":3,"names":["BB","require","fetch","LRU","optCheck","CORGI_DOC","JSON_DOC","module","exports","packument","spec","opts","registry","pickRegistry","uri","replace","escapedName","fetchPackument","MEMO","length","m","_contentLength","max","maxAge","clearMemoized","reset","mem","pickMem","accept","fullMetadata","memoKey","preferOnline","has","resolve","get","concat","headers","name","integrity","then","res","json","_cached","set","catch","err","code","ObjProxy","key","obj","val","PROX","memoize"],"sources":["/Users/hkateliev/node_modules/npm/node_modules/pacote/lib/fetchers/registry/packument.js"],"sourcesContent":["'use strict'\n\nconst BB = require('bluebird')\n\nconst fetch = require('npm-registry-fetch')\nconst LRU = require('lru-cache')\nconst optCheck = require('../../util/opt-check')\n\n// Corgis are cute. ðŸ•ðŸ¶\nconst CORGI_DOC = 'application/vnd.npm.install-v1+json; q=1.0, application/json; q=0.8, */*'\nconst JSON_DOC = 'application/json'\n\nmodule.exports = packument\nfunction packument (spec, opts) {\n  opts = optCheck(opts)\n\n  const registry = fetch.pickRegistry(spec, opts)\n  const uri = registry.replace(/\\/?$/, '/') + spec.escapedName\n\n  return fetchPackument(uri, registry, spec, opts)\n}\n\nconst MEMO = new LRU({\n  length: m => m._contentLength,\n  max: 200 * 1024 * 1024, // 200MB\n  maxAge: 30 * 1000 // 30s\n})\n\nmodule.exports.clearMemoized = clearMemoized\nfunction clearMemoized () {\n  MEMO.reset()\n}\n\nfunction fetchPackument (uri, registry, spec, opts) {\n  const mem = pickMem(opts)\n  const accept = opts.fullMetadata ? JSON_DOC : CORGI_DOC\n  const memoKey = `${uri}~(${accept})`\n  if (mem && !opts.preferOnline && mem.has(memoKey)) {\n    return BB.resolve(mem.get(memoKey))\n  }\n\n  return fetch(uri, opts.concat({\n    headers: {\n      'pacote-req-type': 'packument',\n      'pacote-pkg-id': `registry:${spec.name}`,\n      accept\n    },\n    spec\n  }, opts, {\n    // Force integrity to null: we never check integrity hashes for manifests\n    integrity: null\n  })).then(res => res.json().then(packument => {\n    packument._cached = res.headers.has('x-local-cache')\n    packument._contentLength = +res.headers.get('content-length')\n    // NOTE - we need to call pickMem again because proxy\n    //        objects get reused!\n    const mem = pickMem(opts)\n    if (mem) {\n      mem.set(memoKey, packument)\n    }\n    return packument\n  })).catch(err => {\n    if (err.code === 'E404' && !opts.fullMetadata) {\n      return fetchPackument(uri, registry, spec, opts.concat({\n        fullMetadata: true\n      }))\n    } else {\n      throw err\n    }\n  })\n}\n\nclass ObjProxy {\n  get (key) { return this.obj[key] }\n  set (key, val) { this.obj[key] = val }\n}\n\n// This object is used synchronously and immediately, so\n// we can safely reuse it instead of consing up new ones\nconst PROX = new ObjProxy()\nfunction pickMem (opts) {\n  if (!opts || !opts.memoize) {\n    return MEMO\n  } else if (opts.memoize.get && opts.memoize.set) {\n    return opts.memoize\n  } else if (typeof opts.memoize === 'object') {\n    PROX.obj = opts.memoize\n    return PROX\n  } else {\n    return null\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}